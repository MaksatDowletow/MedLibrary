# MedLibrary

Интерактивная витрина медицинской электронной библиотеки с формами регистрации и входа. Репозиторий содержит статический фронтенд (страница `index.html`) и небольшой Node.js/Express API (`server.js`).

## Запуск API локально

1. Скопируйте файл `.env.example` и переименуйте в `.env`. Укажите строку подключения к MongoDB и секрет для JWT.
2. Установите зависимости и запустите сервер:

```bash
npm install
npm run dev
```

По умолчанию сервер слушает порт `5000`.

> **Примечание.** Если MongoDB временно недоступна, API автоматически переключится на встроенное файловое хранилище `data/users.json`. Пароли в нём сохраняются в виде bcrypt-хешей, поэтому даже без БД можно продолжать локальную разработку и тестирование. Для продакшена по-прежнему рекомендуется полноценная база данных.

## Настройка фронтенда

Форма авторизации использует базовый URL API из параметра запроса `?apiBase=` (например, `auth.html?apiBase=http://localhost:5000`). Если параметр не задан, берётся `window.location.origin`, так что для локальной разработки достаточно открыть страницу на том же домене и порту, что и API.

## Каталог в JSON

- Нормализованный каталог книг теперь лежит в `data/books.json`. Это обычный текстовый файл, который легко просматривать и обновлять в Git, а страница `book.html` загружает его напрямую, поэтому список литературы доступен даже офлайн (сервис‑воркер кэширует файл).
- Для обновления каталога используйте `python scripts/build_catalog.py`. Скрипт преобразует табличный источник `books.html` (TSV) в JSON, очищая значения и сохраняя унифицированные ключи.
- Экспорт в Excel (`Book.xlsx`) по‑прежнему доступен для скачивания, но фронтенд в первую очередь опирается на JSON.

## Каталог из dbMedicalLib.sqlite

- API-эндпоинт `GET /db/catalog` читает таблицы `Book`, `BookCategory`, `Language` и связку `BookCategoryCategories_BookBooks` напрямую через системный клиент `sqlite3`. Ответ содержит массив книг с категориями и языком, а также статистику по количеству категорий и книг.
- Страница `db-catalog.html` визуализирует эти данные: быстрый поиск по названию, авторам, ISBN/УДК/ББК, фильтры по категории и языку и счётчики совпадений.
- Путь к файлу базы можно переопределить через переменную окружения `SQLITE_DB_PATH` (по умолчанию `dbMedicalLib.sqlite` в корне репозитория).

### Офлайн-режим

Если браузеру не удаётся связаться с указанным API (например, сервер не запущен), интерфейс автоматически переключается в офлайн-режим:

- регистрация сохраняет учётные записи в `localStorage` браузера;
- вход сверяет логин/пароль с локально сохранёнными пользователями и создаёт локальную сессию;
- статус авторизации отображается с пометкой «офлайн».

Чтобы сбросить локальные данные, очистите `localStorage` (кнопка «Выход» также удаляет офлайн-сессию). Как только API снова станет доступен, форма автоматически вернётся к работе через сервер и перестанет использовать локальный fallback.

## Маршруты API

- `POST /register` – регистрация пользователя.
- `POST /login` – вход и получение JWT.
- `POST /auth/google` – вход через Google Identity (OAuth 2.0, ID Token).
- `GET /session` – проверка текущего токена.
- `GET /protected` – пример защищённого ресурса.
- `GET /books` – получение каталога книг из MongoDB или резервного JSON.

Все маршруты возвращают сообщения об ошибках в формате JSON, что позволяет фронтенду выводить осмысленные уведомления пользователям.

## Подключение Google Identity

1. Получите OAuth 2.0 Client ID в [Google Cloud Console](https://console.cloud.google.com/apis/credentials). Для тестов можно использовать тип `Web` и добавить `http://localhost:5000` в список разрешённых источников.
2. Укажите Client ID в `.env` (переменная `GOOGLE_CLIENT_ID`). Можно перечислить несколько идентификаторов через запятую. При необходимости ограничьте доменом `GOOGLE_ALLOWED_HD=example.com`.
3. На фронтенде задайте тот же Client ID через `config.js`, передав значение в `window.__APP_CONFIG__`. Не храните рабочие ключи в HTML: скрипт настраивает атрибуты `data-google-client-id` и мета-тег уже в браузере.
4. При необходимости переопределите идентификатор прямо в ссылке: добавьте `?googleClientId=XXX` к `index.html` или `auth.html` (например, `auth.html?apiBase=http://localhost:5000&googleClientId=YYY`). Параметр перекрывает мета-тег и значения из `config.js`.
5. После этого в блоке авторизации появится кнопка «Войти через Google». Пользователь получает обычный JWT, а сервер создаёт локальную учётную запись автоматически, используя адрес электронной почты из Google.

Отдельная страница `auth.html` использует те же настройки, поэтому достаточно поделиться ссылкой вроде `auth.html?apiBase=https://api.example.com&googleClientId=XXX`.
